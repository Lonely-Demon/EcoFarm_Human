name: Synthetic Health Checks

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch:

jobs:
  run-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Run synthetic checks (staging)
        id: staging-checks
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.STAGING_BASE_URL }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [[ -z "$BASE_URL" ]]; then echo "No STAGING_BASE_URL secret configured, skipping..."; exit 0; fi
          set -e
          echo "Checking $BASE_URL..."
          health=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL/healthz) || true
          echo "health: $health"
          if [ "$health" != "200" ]; then echo "Health check failed for $BASE_URL"; echo "body:"; curl -s $BASE_URL/healthz; exit 1; fi
          # Weather
          weather_code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/weather?lat=12.9&lon=80.2") || true
          if [ "$weather_code" != "200" ]; then echo "Weather check failed for $BASE_URL/weather"; exit 1; fi
          # AI recs (POST)
          ai_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" -d '{"lat":12.9,"lon":80.2,"preferred_crops":["tomato"]}' $BASE_URL/ai/rec/) || true
          if [ "$ai_code" != "200" ]; then echo "AI recs check failed for $BASE_URL/ai/rec"; exit 1; fi

      - name: Run synthetic checks (prod)
        id: prod-checks
        continue-on-error: true
        env:
          BASE_URL: ${{ secrets.PROD_BASE_URL }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [[ -z "$BASE_URL" ]]; then echo "No PROD_BASE_URL secret configured, skipping..."; exit 0; fi
          set -e
          echo "Checking $BASE_URL..."
          health=$(curl -s -o /dev/null -w "%{http_code}" $BASE_URL/healthz) || true
          echo "health: $health"
          if [ "$health" != "200" ]; then echo "Health check failed for $BASE_URL"; echo "body:"; curl -s $BASE_URL/healthz; exit 1; fi
          weather_code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/weather?lat=12.9&lon=80.2") || true
          if [ "$weather_code" != "200" ]; then echo "Weather check failed for $BASE_URL/weather"; exit 1; fi
          ai_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" -d '{"lat":12.9,"lon":80.2,"preferred_crops":["tomato"]}' $BASE_URL/ai/rec/) || true
          if [ "$ai_code" != "200" ]; then echo "AI recs check failed for $BASE_URL/ai/rec"; exit 1; fi

      - name: Post to Slack (optional)
        if: ${{ always() && secrets.SLACK_WEBHOOK != '' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          STAGING_STATUS: ${{ steps.staging-checks.outcome }}
          PROD_STATUS: ${{ steps.prod-checks.outcome }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then echo "No SLACK_WEBHOOK set"; exit 0; fi
          
          # Determine overall status and color
          if [ "$STAGING_STATUS" = "success" ] && [ "$PROD_STATUS" = "success" ]; then
            OVERALL_STATUS="‚úÖ PASSED"
            COLOR="36a64f"
          elif [ "$STAGING_STATUS" = "failure" ] || [ "$PROD_STATUS" = "failure" ]; then
            OVERALL_STATUS="‚ùå FAILED"
            COLOR="ff0000"
          else
            OVERALL_STATUS="‚ö†Ô∏è PARTIAL"
            COLOR="ffaa00"
          fi
          
          # Build Slack message with Blocks API for rich formatting
          payload=$(jq -n \
            --arg status "$OVERALL_STATUS" \
            --arg color "$COLOR" \
            --arg staging "$STAGING_STATUS" \
            --arg prod "$PROD_STATUS" \
            --arg url "$RUN_URL" \
            '{
              "attachments": [
                {
                  "fallback": "Synthetic checks: " + $status,
                  "color": $color,
                  "title": "Synthetic Health Checks - " + $status,
                  "title_link": $url,
                  "fields": [
                    {
                      "title": "Staging",
                      "value": $staging,
                      "short": true
                    },
                    {
                      "title": "Production",
                      "value": $prod,
                      "short": true
                    }
                  ],
                  "footer": "EcoFarm CI/CD",
                  "ts": (now | floor)
                }
              ]
            }')
          
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK"

      - name: Check for repeated failures and escalate to GitHub Issues
        if: ${{ always() && (steps.staging-checks.outcome == 'failure' || steps.prod-checks.outcome == 'failure') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          STAGING_STATUS: ${{ steps.staging-checks.outcome }}
          PROD_STATUS: ${{ steps.prod-checks.outcome }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Fetch recent synthetic check runs to count consecutive failures
          FAILED_RUNS=$(gh run list --workflow=synthetic-checks.yml --status=failure --json conclusion,databaseId --limit=10 | jq 'map(select(.conclusion == "failure")) | length')
          
          echo "Found $FAILED_RUNS consecutive failed runs"
          
          # If 2+ consecutive failures, create or update GitHub Issue
          if [ "$FAILED_RUNS" -ge 2 ]; then
            echo "Creating GitHub Issue for repeated synthetic check failures..."
            
            # Check if issue already exists
            EXISTING_ISSUE=$(gh issue list --search "label:synthetic-check-failure state:open" --json number --jq '.[0].number' || echo "")
            
            if [ -z "$EXISTING_ISSUE" ]; then
              # Create new issue
              ISSUE_BODY="## Synthetic Health Checks Failing

**Status**: Repeated failure detected (${FAILED_RUNS} consecutive runs)

**Affected Environments**:
- Staging: ${STAGING_STATUS}
- Production: ${PROD_STATUS}

**Latest Run**: [View Details](${RUN_URL})

**Action Required**: Investigate service health and API endpoint availability.

---
*Automated escalation from synthetic health check workflow*"
              
              gh issue create \
                --title "üö® Synthetic Health Checks Failing" \
                --body "$ISSUE_BODY" \
                --label "synthetic-check-failure,urgent" \
                --assignee "@me" || echo "Issue creation failed"
            else
              # Update existing issue with latest info
              echo "Updating existing issue #$EXISTING_ISSUE..."
              gh issue comment $EXISTING_ISSUE --body "**Update**: Still failing (run $RUN_ID) - ${FAILED_RUNS} consecutive runs. [View latest](${RUN_URL})"
            fi
          else
            echo "Failure count below escalation threshold, no GitHub Issue created"
          fi
